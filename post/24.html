<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>Minecode</title><meta name="viewport" content="initial-scale=1.0, width=device-width"/><meta name="next-head-count" content="3"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/css/7e3d76f3b94b138f978c.css" as="style"/><link rel="stylesheet" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/css/7e3d76f3b94b138f978c.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/framework.bbb3e954997faabb7e25.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/4d394b6eac41034d52403a9c69bab475456b68cd.d652d981997954f1823c.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/main-a4e981f84634301fc825.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/pages/_app-ffad712006e2376eb55f.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/cb1608f2.bf396927f64ce5779777.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/7f039369aadd54df2b7485d9d62ad716e7ffd267.817674e39317854a8e95.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/122b2f7543d3b8cb2e0483e1b11b9e7f4c8a85b5.2959378f7e30a76c2452.js" as="script"/><link rel="preload" href="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/pages/post/%5Bid%5D-3ba8416640705b8635fe.js" as="script"/></head><body><div id="__next"><main><nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top"><div class="container"><a class="navbar-brand" href="/"><img src="/images/logo.png" width="30" height="30" alt=""/><span> Minecode</span></a><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button></div></nav><div class="content"><div style="box-sizing:border-box;position:relative;height:400px;width:100%;overflow:hidden"><div class="container-fluid" id="content" style="background-image:url(https://miro.medium.com/max/1400/0*4jsx5ST4MjWkbRY9);background-size:cover;background-repeat:no-repeat;background-position:center;filter:blur(8px);height:100%;width:100%;position:absolute"></div><div class="container-fluid" style="background-color:rgb(0,0,0,0.5);color:white;font-weight:bold;z-index:2;height:100%;width:100%;text-align:center;position:relative"><div class="pricing-header px-3 py-3 mx-auto text-center" id="title"><h1 class="display-4" style="color:#fff;margin-top:5%">Transforme os seus Raspberry Pi num &quot;cluster&quot; de forma rápida e indolor<br/></h1></div><div class="px-3 py-3 pb-md-4 mx-auto text-center"><div class="d-flex align-middle justify-content-center align-items-center"><div class="row"><div class="align-self-center p-2" id="infoPost"><p style="color:#fff;font-size:16px">Posted on <!-- -->April, 2020<!-- --> by<a class="mt-3 mb-4 btn btn-sm" href="https://github.com/tiagoslucas" target="_blank" rel="noopener noreferrer" style="color:#fff">tiagoslucas<!-- --> <img class="rounded-circle" src="https://avatars.githubusercontent.com/u/25772694?v=4" alt="Github" width="24" height="24"/></a></p></div></div></div></div></div></div><div class="container"><div class="pt-md-5 pb-md-4 mx-auto" id="post"><div><p>Com o desenvolvimento da tecnologia, cada vez menos temos interação com o que se passa dentro dos nossos computadores. Uma pessoa que frequente os <em>websites</em> e fóruns de tecnologia, certamente já terá ouvido falar em “cluster”. Mas afinal, o que é um “cluster”? Nada como pôr as mãos na massa…</p><p><img alt="medium" src="https://miro.medium.com/max/1400/0*4jsx5ST4MjWkbRY9"/></p><p>Photo by <a href="https://unsplash.com/@kiboka">Nadya Spetnitskaya</a> on <a href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral">Unsplash</a></p><p>Vamos portanto criar um <em>cluster</em> com Kubernetes.</p><p>Para este projeto, vamos construir um <em>cluster</em> usando 3 Raspberry Pi. Infelizmente, o suporte para Pi 1 foi descontinuado pelo Kubernetes, portanto todas as máquinas terão de ser posteriores à 1ª geração do <em>Single-Board Computer</em>. Recomendamos vivamente uma ligação à rede por cabo, apesar de ser opcional.</p><h1>1<!-- -->.<!-- --> Instalação</h1><p>O primeiro passo é formatar os cartões microSD. Vamos usar o <em>Raspbian Lite</em>, por ser um sistema operativo leve e supervisionado pela própria <em>Raspberry Pi Foundation</em>. Existe uma grande quantidade de ferramentas gratuitas que podem ser usadas para este processo. Usámos o <em>Win32 Disk Manager</em>:</p><p><img alt="medium" src="https://miro.medium.com/max/960/1*0f_ENEU6pvApJqtPeFejKg.png"/></p><p>Ao iniciarmos o nosso Raspberry devemos mudar o <em>hostname,</em> uma vez que <em>hostnames</em> repetidos no mesmo <em>cluster</em> tendem a gerar problemas. Pode ser feito usando a ferramenta de configuração:</p><pre><code>sudo raspi-config</code></pre><p>O Kubernetes funciona com o auxílio de contentores Docker, uma plataforma fácil de instalar:</p><pre><code>curl -sSL get.docker.com | sh &amp;&amp; sudo usermod pi -aG docker  
newgrp docker</code></pre><p>Para assegurar o bom funcionamento do <em>cluster</em>, nas versões mais recentes do Kubernetes, é necessário desativar o espaço de <em>swap</em>:</p><pre><code>sudo dphys-swapfile swapoff &amp;&amp; sudo dphys-swapfile uninstall &amp;&amp; \\ sudo update-rc.d dphys-swapfile remove</code></pre><p>Também é necessário que o processo <em>cgroup</em> inicie com o computador, que pode ser feito acrescentando comandos ao ficheiro de inicialização:</p><pre><code>sudo nano /boot/cmdline.txt</code></pre><p><strong>Sem adicionar nenhuma linha</strong>, é necessário adicionar à linha existente:</p><pre><code>cgroup\_enable=cpuset cgroup\_memory=1 cgroup\_enable=memory</code></pre><blockquote><p>Agora vamos reiniciar o Raspberry Pi.</p></blockquote><p>Finalmente, vamos instalar o Kubernetes e descarregar os ficheiros de configuração:</p><pre><code>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add - &amp;&amp; \\  
echo &quot;deb http://apt.kubernetes.io/ kubernetes-xenial main&quot; | sudo tee /etc/apt/sources.list.d/kubernetes.list &amp;&amp; \\  
sudo apt-get update -q &amp;&amp; sudo apt-get install -qy kubeadm  
sudo kubeadm config images pull -v3</code></pre><h1>2<!-- -->.<!-- --> Configuração no “Master”</h1><p>Depois das ferramentas instaladas, vamos configurar o nosso nó <em>master</em>. Começando por iniciar um novo cluster Kubernetes:</p><pre><code>sudo kubeadm init --token-ttl=0 --pod-network-cidr=10.244.0.0/16</code></pre><p>Este comando pode demorar até 15 minutos para estar finalizado, dando tempo para se repetir o processo de instalação nos <em>workers</em> do <em>cluster</em>. Os argumentos necessários para a configuração dos mesmos só serão apresentados no final desse tempo. Deve ter vagamente o seguinte aspecto:</p><pre><code>kubeadm join --token 9e700f.7dc97f5e3a45c9e5 192.168.0.27:6443 --discovery-token-ca-cert-hash sha256:95cbb9ee5536aa61ec0239d6edd8598af68758308d0a0425848ae1af28859bea</code></pre><p>Como indicado aos que prestam atenção, devemos correr o seguinte <em>snippet</em>:</p><pre><code>mkdir -p $HOME/.kube  
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  
sudo chown $(id -u):$(id -g) $HOME/.kube/config</code></pre><p>De seguida, vamos configurar o <em>flannel</em>, a ferramenta de auxílio de rede que usamos neste caso:</p><pre><code>kubectl apply -f [https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml](https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml)  
sudo sysctl net.bridge.bridge-nf-call-iptables=1</code></pre><h1>3<!-- -->.<!-- --> Configuração nos Workers</h1><p>Assumindo que o <em>worker</em> já está configurado e o comando de <em>join</em> já foi dado pelo <em>kubeadm</em> no <em>master</em>, devemos usar o mesmo em cada <em>worker</em>. De seguida, para utilizar o <em>flannel</em>, usamos o seguinte:</p><pre><code>sudo sysctl net.bridge.bridge-nf-call-iptables=1</code></pre><p>Devemos agora ter o nosso cluster a funcionar. Isso pode ser verificado dando o seguinte comando no <em>master</em>:</p><pre><code>kubectl get nodes</code></pre><p>Se todos os nós aparecerem na lista, o seu <em>cluster</em> está montado.</p><p>Referência: <a href="https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/">https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/</a></p></div></div><div class="text-center"><a href="/tag/Cluster" class="m-1 btn btn-primary" style="background-color:#d85d58;border:none">Cluster</a><a href="/tag/Raspberry Pi" class="m-1 btn btn-primary" style="background-color:#db6f87;border:none">Raspberry Pi</a></div><div class="mt-5 mb-5"></div><div class="row justify-content-center"><div class="col-4 row justify-content-center"><div class="align-self-center p-2">tiagoslucas<a class="mt-3 mb-4 btn btn-sm" href="https://github.com/tiagoslucas" target="_blank" rel="noopener noreferrer" style="color:#fff"><img class="rounded-circle" src="https://avatars.githubusercontent.com/u/25772694?v=4" alt="Github" width="24" height="24"/></a></div></div></div></div></div></main><footer class="py-5 bg-dark"><div class="container"><p class="m-0 text-center text-white">Copyright © Minecode 2020</p><p class="text-center mt-2"><a href="http://www.freepik.com">Designed by slidesgo, stories and macrovector / Freepik</a></p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"url":"https://api.github.com/repos/minecode/minecode.github.io/issues/24","repository_url":"https://api.github.com/repos/minecode/minecode.github.io","labels_url":"https://api.github.com/repos/minecode/minecode.github.io/issues/24/labels{/name}","comments_url":"https://api.github.com/repos/minecode/minecode.github.io/issues/24/comments","events_url":"https://api.github.com/repos/minecode/minecode.github.io/issues/24/events","html_url":"https://github.com/minecode/minecode.github.io/issues/24","id":603586342,"node_id":"MDU6SXNzdWU2MDM1ODYzNDI=","number":24,"title":"[POST] Transforme os seus Raspberry Pi num \"cluster\" de forma rápida e indolor","user":{"login":"tiagoslucas","id":25772694,"node_id":"MDQ6VXNlcjI1NzcyNjk0","avatar_url":"https://avatars.githubusercontent.com/u/25772694?v=4","gravatar_id":"","url":"https://api.github.com/users/tiagoslucas","html_url":"https://github.com/tiagoslucas","followers_url":"https://api.github.com/users/tiagoslucas/followers","following_url":"https://api.github.com/users/tiagoslucas/following{/other_user}","gists_url":"https://api.github.com/users/tiagoslucas/gists{/gist_id}","starred_url":"https://api.github.com/users/tiagoslucas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tiagoslucas/subscriptions","organizations_url":"https://api.github.com/users/tiagoslucas/orgs","repos_url":"https://api.github.com/users/tiagoslucas/repos","events_url":"https://api.github.com/users/tiagoslucas/events{/privacy}","received_events_url":"https://api.github.com/users/tiagoslucas/received_events","type":"User","site_admin":false},"labels":[{"id":2002696420,"node_id":"MDU6TGFiZWwyMDAyNjk2NDIw","url":"https://api.github.com/repos/minecode/minecode.github.io/labels/Cluster","name":"Cluster","color":"d85d58","default":false,"description":""},{"id":2002695756,"node_id":"MDU6TGFiZWwyMDAyNjk1NzU2","url":"https://api.github.com/repos/minecode/minecode.github.io/labels/Raspberry%20Pi","name":"Raspberry Pi","color":"db6f87","default":false,"description":""},{"id":1923405712,"node_id":"MDU6TGFiZWwxOTIzNDA1NzEy","url":"https://api.github.com/repos/minecode/minecode.github.io/labels/post","name":"post","color":"2dc64e","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2020-04-20T22:56:01Z","updated_at":"2020-04-21T09:20:47Z","closed_at":"2020-04-20T23:22:45Z","author_association":"NONE","active_lock_reason":null,"body":"Com o desenvolvimento da tecnologia, cada vez menos temos interação com o que se passa dentro dos nossos computadores. Uma pessoa que frequente os _websites_ e fóruns de tecnologia, certamente já terá ouvido falar em “cluster”. Mas afinal, o que é um “cluster”? Nada como pôr as mãos na massa…\r\n\r\n![medium](https://miro.medium.com/max/1400/0*4jsx5ST4MjWkbRY9)\r\n\r\nPhoto by [Nadya Spetnitskaya](https://unsplash.com/@kiboka) on [Unsplash](https://unsplash.com?utm_source=medium\u0026utm_medium=referral)\r\n\r\nVamos portanto criar um _cluster_ com Kubernetes.\r\n\r\nPara este projeto, vamos construir um _cluster_ usando 3 Raspberry Pi. Infelizmente, o suporte para Pi 1 foi descontinuado pelo Kubernetes, portanto todas as máquinas terão de ser posteriores à 1ª geração do _Single-Board Computer_. Recomendamos vivamente uma ligação à rede por cabo, apesar de ser opcional.\r\n\r\n1\\. Instalação\r\n==============\r\n\r\nO primeiro passo é formatar os cartões microSD. Vamos usar o _Raspbian Lite_, por ser um sistema operativo leve e supervisionado pela própria _Raspberry Pi Foundation_. Existe uma grande quantidade de ferramentas gratuitas que podem ser usadas para este processo. Usámos o _Win32 Disk Manager_:\r\n\r\n![medium](https://miro.medium.com/max/960/1*0f_ENEU6pvApJqtPeFejKg.png)\r\n\r\nAo iniciarmos o nosso Raspberry devemos mudar o _hostname,_ uma vez que _hostnames_ repetidos no mesmo _cluster_ tendem a gerar problemas. Pode ser feito usando a ferramenta de configuração:\r\n\r\n```\r\nsudo raspi-config\r\n```\r\n\r\nO Kubernetes funciona com o auxílio de contentores Docker, uma plataforma fácil de instalar:\r\n\r\n```\r\ncurl -sSL get.docker.com | sh \u0026\u0026 sudo usermod pi -aG docker  \r\nnewgrp docker\r\n```\r\n\r\nPara assegurar o bom funcionamento do _cluster_, nas versões mais recentes do Kubernetes, é necessário desativar o espaço de _swap_:\r\n\r\n```\r\nsudo dphys-swapfile swapoff \u0026\u0026 sudo dphys-swapfile uninstall \u0026\u0026 \\\\ sudo update-rc.d dphys-swapfile remove\r\n```\r\n\r\nTambém é necessário que o processo _cgroup_ inicie com o computador, que pode ser feito acrescentando comandos ao ficheiro de inicialização:\r\n\r\n```\r\nsudo nano /boot/cmdline.txt\r\n```\r\n\r\n**Sem adicionar nenhuma linha**, é necessário adicionar à linha existente:\r\n\r\n```\r\ncgroup\\_enable=cpuset cgroup\\_memory=1 cgroup\\_enable=memory\r\n```\r\n\r\n\u003e Agora vamos reiniciar o Raspberry Pi.\r\n\r\nFinalmente, vamos instalar o Kubernetes e descarregar os ficheiros de configuração:\r\n\r\n```\r\ncurl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add - \u0026\u0026 \\\\  \r\necho \"deb http://apt.kubernetes.io/ kubernetes-xenial main\" | sudo tee /etc/apt/sources.list.d/kubernetes.list \u0026\u0026 \\\\  \r\nsudo apt-get update -q \u0026\u0026 sudo apt-get install -qy kubeadm  \r\nsudo kubeadm config images pull -v3\r\n```\r\n\r\n2\\. Configuração no “Master”\r\n============================\r\n\r\nDepois das ferramentas instaladas, vamos configurar o nosso nó _master_. Começando por iniciar um novo cluster Kubernetes:\r\n\r\n```\r\nsudo kubeadm init --token-ttl=0 --pod-network-cidr=10.244.0.0/16\r\n```\r\n\r\nEste comando pode demorar até 15 minutos para estar finalizado, dando tempo para se repetir o processo de instalação nos _workers_ do _cluster_. Os argumentos necessários para a configuração dos mesmos só serão apresentados no final desse tempo. Deve ter vagamente o seguinte aspecto:\r\n\r\n```\r\nkubeadm join --token 9e700f.7dc97f5e3a45c9e5 192.168.0.27:6443 --discovery-token-ca-cert-hash sha256:95cbb9ee5536aa61ec0239d6edd8598af68758308d0a0425848ae1af28859bea\r\n```\r\n\r\nComo indicado aos que prestam atenção, devemos correr o seguinte _snippet_:\r\n\r\n```\r\nmkdir -p $HOME/.kube  \r\nsudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config  \r\nsudo chown $(id -u):$(id -g) $HOME/.kube/config\r\n```\r\n\r\nDe seguida, vamos configurar o _flannel_, a ferramenta de auxílio de rede que usamos neste caso:\r\n\r\n```\r\nkubectl apply -f [https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml](https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml)  \r\nsudo sysctl net.bridge.bridge-nf-call-iptables=1\r\n```\r\n\r\n3\\. Configuração nos Workers\r\n============================\r\n\r\nAssumindo que o _worker_ já está configurado e o comando de _join_ já foi dado pelo _kubeadm_ no _master_, devemos usar o mesmo em cada _worker_. De seguida, para utilizar o _flannel_, usamos o seguinte:\r\n\r\n```\r\nsudo sysctl net.bridge.bridge-nf-call-iptables=1\r\n```\r\n\r\nDevemos agora ter o nosso cluster a funcionar. Isso pode ser verificado dando o seguinte comando no _master_:\r\n\r\n```\r\nkubectl get nodes\r\n```\r\n\r\nSe todos os nós aparecerem na lista, o seu _cluster_ está montado.\r\n\r\nReferência: [https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/](https://blog.alexellis.io/serverless-kubernetes-on-raspberry-pi/)\r\n","closed_by":{"login":"cfchenr","id":17366849,"node_id":"MDQ6VXNlcjE3MzY2ODQ5","avatar_url":"https://avatars.githubusercontent.com/u/17366849?v=4","gravatar_id":"","url":"https://api.github.com/users/cfchenr","html_url":"https://github.com/cfchenr","followers_url":"https://api.github.com/users/cfchenr/followers","following_url":"https://api.github.com/users/cfchenr/following{/other_user}","gists_url":"https://api.github.com/users/cfchenr/gists{/gist_id}","starred_url":"https://api.github.com/users/cfchenr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cfchenr/subscriptions","organizations_url":"https://api.github.com/users/cfchenr/orgs","repos_url":"https://api.github.com/users/cfchenr/repos","events_url":"https://api.github.com/users/cfchenr/events{/privacy}","received_events_url":"https://api.github.com/users/cfchenr/received_events","type":"User","site_admin":false},"performed_via_github_app":null},"relatedPosts":[]},"__N_SSG":true},"page":"/post/[id]","query":{"id":"24"},"buildId":"u8zW19TnfOuce_n6hjyVG","assetPrefix":"https://cdn.statically.io/gh/minecode/minecode.github.io/master","isFallback":false,"gsp":true}</script><script nomodule="" src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/polyfills-28654a8145d7603786fc.js"></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/webpack-50bee04d1dc61f8adf5b.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/framework.bbb3e954997faabb7e25.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/4d394b6eac41034d52403a9c69bab475456b68cd.d652d981997954f1823c.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/main-a4e981f84634301fc825.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/pages/_app-ffad712006e2376eb55f.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/cb1608f2.bf396927f64ce5779777.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/7f039369aadd54df2b7485d9d62ad716e7ffd267.817674e39317854a8e95.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/122b2f7543d3b8cb2e0483e1b11b9e7f4c8a85b5.2959378f7e30a76c2452.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/chunks/pages/post/%5Bid%5D-3ba8416640705b8635fe.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/u8zW19TnfOuce_n6hjyVG/_buildManifest.js" async=""></script><script src="https://cdn.statically.io/gh/minecode/minecode.github.io/master/_next/static/u8zW19TnfOuce_n6hjyVG/_ssgManifest.js" async=""></script></body></html>